<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>How to do data integration, BRD example (part3) - DataPlatform Franchising</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="http://datapfranc.github.io/images/favicon.png" rel="icon">

<link rel="canonical" href="http://datapfranc.github.io/misc/BRD_DI_part3/">

        <meta name="author" content="Martin Ouellet" />
        <meta name="keywords" content="BRD,data integration" />
        <meta name="description" content="Business Layer This layer contains derived data needed by Presentation/Delivery layer. We can build components like associations, groupings or hierarchies defined by Business Rules, and also do data cleansing to fix issues found in our raw data. Building new association: Similar Reviews Let&#39;s say we&#39;re required to find similar reviews written on Work. This could be useful for: Identify duplication issues Identify users duplicating reviews within or across sites Identify spam where reviews are written to bias opinion Find plagiarism among reviewers How do we do that? Data processing on unstructured text is efficiently done using NoSQL ..." />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://datapfranc.github.io/theme/css/bootstrap.cosmo.min.css" type="text/css"/>
    <link href="http://datapfranc.github.io/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://datapfranc.github.io/theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="http://datapfranc.github.io/theme/css/style.css" type="text/css"/>
        <link href="http://datapfranc.github.io/static/custom.css" rel="stylesheet">

        <link href="http://datapfranc.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="DataPlatform Franchising ATOM Feed"/>

</head>
<body>
<!-- <script src="http://datapfranc.github.io/theme/js/jquery.min.js"></script> -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://datapfranc.github.io/" class="navbar-brand">
<img src="http://datapfranc.github.io/images/logo.png" width="36"/> DataPlatform Franchising            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://datapfranc.github.io/about.html">
                             About
                          </a></li>
                         <li><a href="http://datapfranc.github.io/context.html">
                             Context
                          </a></li>
                         <li><a href="http://datapfranc.github.io/brd_intro.html">
                             BRD
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://datapfranc.github.io/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <div class="well well-sm">
              <!-- <div class="panel-heading"> -->
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-06-02T09:07:00+02:00"> Thu 02 June 2016</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://datapfranc.github.io/tags/brd.html">BRD</a>
        /
	<a href="http://datapfranc.github.io/tags/data-integration.html">data integration</a>
    
</footer><!-- /.post-info -->              <!-- </div> -->
            </div>
            <h1 class="entry-title">
                <a href="http://datapfranc.github.io/misc/BRD_DI_part3/"
                rel="bookmark"
                title="Permalink to How to do data integration, BRD example (part3)">
                    How to do data integration, BRD example (part3)
                </a>
            </h1>

            <div class="entry-content">
                <h2 id="business-layer">Business Layer</h2>
<p>This layer contains derived data needed by Presentation/Delivery layer. We can build components like associations, groupings or hierarchies defined by Business Rules, and also do data cleansing to fix issues found in our <em>raw data</em>.  </p>
<h3 id="building-new-association-similar-reviews">Building new association: Similar Reviews</h3>
<p>Let's say we're required to find similar reviews written on Work. This could be useful for:</p>
<ul>
<li>Identify duplication issues</li>
<li>Identify users duplicating reviews within or across sites</li>
<li>Identify spam where reviews are written to bias opinion</li>
<li>Find plagiarism among reviewers</li>
</ul>
<p>How do we do that?  Data processing on unstructured text is efficiently done using NoSQL engines with massively parallel processing (MPP) capability. These engines leverage a "divide and conquer" strategy by distributing reviews among different cluster nodes.  That would be helpful considering the sheer number of comparisons needed to process m reviews (approaching mXm).  </p>
<p>This would be a good use-case of complementary utilization between modern NoSQL engines and traditional RDBMS-based engines.  However this demonstration only uses a sub-set of reviews, so neither data volume/rate nor latency constraint impose MPP-based engines.  We can directly proceed within PostgreSQL by leveraging text comparison functions like trigram (see module <a href="https://www.postgresql.org/docs/current/static/pgtrgm.html">pg_trgm</a>).</p>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/N-gram">N-gram</a> is a way to represent documents as set of sequential items (could b words, letters...).  Trigram is the 3-item version of the generic n-gram and for letters will results to a 26^3 dimensional space.  It's shown that two documents with similar n-gram vector-representation are likely to be similar, and consequently this technique has many applications in <a href="https://en.wikipedia.org/wiki/N-gram#Applications_and_consideration">NLP</a> (e.g. identifying lexically similar documents, detecting plagiarism, ..).</p>
</blockquote>
<p>Here's an example of two reviews done on the book <em>A People's History of the United States</em> :</p>
<table class="table table-hover table-striped">
<thead>
<tr>
<th align="left">User-uid</th>
<th align="left">Review text</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">21587504-zeus-polak</td>
<td align="left"><em>This should be required reading for every American.</em></td>
</tr>
<tr>
<td align="left">14259285-samantha</td>
<td align="left"><em>every american should be required to read this book.</em></td>
</tr>
</tbody>
</table>
<p>The similarity index between the two equals 0.732143.  This captures well the fact that both convey the same meaning and shows its robustness against word ordering variation.</p>
<p>However, to avoid catching too many of these small variations of words permutation we'll filter out too short reviews.</p>
<h4 id="database-implementation">Database implementation</h4>
<p>Let's define a working table <code>rev_similarto_process</code> that will store needed review-to-review pair combinations to process:</p>
<div class="highlight"><pre><span></span><span class="k">create</span> <span class="k">table</span> <span class="n">integration</span><span class="p">.</span><span class="n">rev_similarto_process</span> <span class="p">(</span>
    <span class="n">work_refid</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">review_id</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">text_length</span> <span class="nb">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">review_lang</span> <span class="nb">char</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">other_review_id</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">similarity</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">date_processed</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">create_dts</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">load_audit_id</span> <span class="nb">int</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">work_refid</span><span class="p">,</span> <span class="n">review_id</span><span class="p">),</span>
    <span class="k">check</span> <span class="p">(</span><span class="n">other_review_id</span> <span class="o">&lt;</span> <span class="n">review_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">comment</span> <span class="k">on</span> <span class="k">table</span> <span class="n">integration</span><span class="p">.</span><span class="n">rev_similarto_process</span> <span class="k">is</span> <span class="s1">'Use to help manage the similar processing reviews (keep all reviews processed or being processed'</span><span class="p">;</span>
<span class="k">comment</span> <span class="k">on</span> <span class="k">column</span> <span class="n">integration</span><span class="p">.</span><span class="n">rev_similarto_process</span><span class="p">.</span><span class="n">review_id</span> <span class="k">is</span> <span class="s1">'The review being compared for similarity'</span><span class="p">;</span>
<span class="k">comment</span> <span class="k">on</span> <span class="k">column</span> <span class="n">integration</span><span class="p">.</span><span class="n">rev_similarto_process</span><span class="p">.</span><span class="n">other_review_id</span> <span class="k">is</span> <span class="s1">'The other review found to be similar to review (min id if more than one found, or NULL if none is found)'</span><span class="p">;</span>
<span class="k">comment</span> <span class="k">on</span> <span class="k">column</span> <span class="n">integration</span><span class="p">.</span><span class="n">rev_similarto_process</span><span class="p">.</span><span class="n">similarity</span> <span class="k">is</span> <span class="s1">'Similarity index between the two reviews using tri-gram (pg_trgm)'</span><span class="p">;</span>
<span class="k">comment</span> <span class="k">on</span> <span class="k">column</span> <span class="n">integration</span><span class="p">.</span><span class="n">rev_similarto_process</span><span class="p">.</span><span class="n">date_processed</span> <span class="k">is</span> <span class="s1">'Flag indicating when review comparison was processed (NULL when not yet processed)'</span><span class="p">;</span>
</pre></div>
<p>We can restrict comparison only among the <strong>m</strong> reviews done on <u>same</u> Work.  Out of the mXm possible pairs, we ignore same review pair (r1,r1 --where review is compared to itself), and only keep one pair of the same pair (r1,r2 and r2,r1  --where only ordering changes).  This results to <a href="https://en.wikipedia.org/wiki/Binomial_coefficient"><em>m choose 2</em></a>) pair combination.</p>
<p>Using the source <code>rev_similarto_process</code> table, this would translate into SQL:</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">rev</span><span class="p">.</span><span class="n">work_refid</span><span class="p">,</span>
        <span class="p">,</span><span class="n">rev</span><span class="p">.</span><span class="n">review_id</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">review</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">site_id</span>
        <span class="p">,</span><span class="n">other</span><span class="p">.</span><span class="n">review_id</span> <span class="k">as</span> <span class="n">other_id</span><span class="p">,</span> <span class="n">o</span><span class="p">.</span><span class="n">review</span> <span class="k">as</span> <span class="n">other_review</span><span class="p">,</span> <span class="n">o</span><span class="p">.</span><span class="n">site_id</span> <span class="k">as</span> <span class="n">other_site_id</span>
        <span class="p">,</span><span class="n">similarity</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">review</span><span class="p">,</span> <span class="n">o</span><span class="p">.</span><span class="n">review</span><span class="p">)</span>
<span class="k">from</span> <span class="n">integration</span><span class="p">.</span><span class="n">rev_similarto_process</span> <span class="n">rev</span>
<span class="k">join</span> <span class="n">integration</span><span class="p">.</span><span class="n">review</span> <span class="n">r</span> <span class="k">on</span> <span class="p">(</span><span class="n">rev</span><span class="p">.</span><span class="n">review_id</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">join</span> <span class="n">integration</span><span class="p">.</span><span class="n">rev_similarto_process</span> <span class="n">other</span> <span class="k">on</span>
          <span class="p">(</span><span class="n">rev</span><span class="p">.</span><span class="n">work_refid</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">work_refid</span>
          <span class="k">and</span> <span class="n">rev</span><span class="p">.</span><span class="n">review_lang</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">review_lang</span>
          <span class="k">and</span> <span class="n">rev</span><span class="p">.</span><span class="n">review_id</span> <span class="o">&gt;</span> <span class="n">other</span><span class="p">.</span><span class="n">review_id</span>
          <span class="k">and</span> <span class="n">rev</span><span class="p">.</span><span class="n">text_length</span> <span class="k">between</span> <span class="n">other</span><span class="p">.</span><span class="n">text_length</span> <span class="o">-</span> <span class="n">round</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">text_length</span> <span class="o">*</span> <span class="o">%</span><span class="p">(</span><span class="n">len_delta</span><span class="p">)</span><span class="n">s</span><span class="p">)</span> <span class="k">and</span>
                                      <span class="n">other</span><span class="p">.</span><span class="n">text_length</span> <span class="o">+</span> <span class="n">round</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">text_length</span> <span class="o">*</span> <span class="o">%</span><span class="p">(</span><span class="n">len_delta</span><span class="p">)</span><span class="n">s</span><span class="p">))</span>
<span class="k">join</span> <span class="n">integration</span><span class="p">.</span><span class="n">review</span> <span class="n">o</span> <span class="k">on</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">review_id</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">where</span>
  <span class="n">rev</span><span class="p">.</span><span class="n">date_processed</span> <span class="k">IS</span> <span class="k">NULL</span>
  <span class="k">and</span> <span class="n">rev</span><span class="p">.</span><span class="n">text_length</span> <span class="o">&gt;=</span> <span class="o">%</span><span class="p">(</span><span class="n">len_min</span><span class="p">)</span><span class="n">s</span>
  <span class="k">and</span> <span class="n">other</span><span class="p">.</span><span class="n">text_length</span> <span class="o">&gt;=</span> <span class="o">%</span><span class="p">(</span><span class="n">len_min</span><span class="p">)</span><span class="n">s</span>
</pre></div>
<p>Cross joining reviews only using <code>work_refid</code> produces a mXm cross-product. This is reduced to a combinatory <em>m choose 2</em> with clause <code>and rev.review_id &gt; other.review_id</code>.  We can also limit comparison to reviews of same language (<code>rev.review_lang = other.review_lang</code>), of similar number of characters (<code>rev.text_length between other.text_length - round(other.text_length * %(len_delta)s)</code> <code>and  other.text_length + round(other.text_length * %(len_delta)s))</code>) and finally having a minimum number of characters  (<code>rev.text_length &gt;= %(len_min)s</code>).</p>
<p>We use above query to process a batch of reviews into a temporary staging table. To avoid having too many rows to calculate similarity on, we limit each batch to some number of Work.  The pg_trgm is quite slow as it needs to chunk each text into a set of all 3 (and less) letters sequence.</p>
<p>We then calculate similarity of each pairs on this temporary table and load the end-result table using a threshold on similarity:</p>
<div class="highlight"><pre><span></span><span class="k">create</span> <span class="k">table</span> <span class="n">integration</span><span class="p">.</span><span class="n">review_similarto</span> <span class="p">(</span>
    <span class="n">review_id</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">other_review_id</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">similarity</span> <span class="nb">float</span><span class="p">,</span>
    <span class="k">check</span> <span class="p">(</span><span class="n">other_review_id</span> <span class="o">&lt;</span> <span class="n">review_id</span><span class="p">),</span>
    <span class="k">primary</span> <span class="k">key</span><span class="p">(</span><span class="n">review_id</span><span class="p">,</span> <span class="n">other_review_id</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span><span class="p">(</span><span class="n">review_id</span><span class="p">)</span> <span class="k">references</span> <span class="n">integration</span><span class="p">.</span><span class="n">review</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span><span class="p">(</span><span class="n">other_review_id</span><span class="p">)</span> <span class="k">references</span> <span class="n">integration</span><span class="p">.</span><span class="n">review</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="n">create_dts</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">load_audit_id</span> <span class="nb">int</span><span class="p">,</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">load_audit_id</span><span class="p">)</span> <span class="k">references</span> <span class="n">staging</span><span class="p">.</span><span class="n">load_audit</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">comment</span> <span class="k">on</span> <span class="k">table</span> <span class="n">integration</span><span class="p">.</span><span class="n">review_similarto</span> <span class="k">is</span> <span class="s1">'Track down reviews having some similarity with others (min threshold on the trigram calculation)'</span><span class="p">;</span>
<span class="k">comment</span> <span class="k">on</span> <span class="k">column</span> <span class="n">integration</span><span class="p">.</span><span class="n">review_similarto</span><span class="p">.</span><span class="n">review_id</span> <span class="k">is</span> <span class="s1">'Review-id  (under constraint: larger than other_rev_id to avoid dup pairwise comparison)'</span><span class="p">;</span>
<span class="k">comment</span> <span class="k">on</span> <span class="k">column</span> <span class="n">integration</span><span class="p">.</span><span class="n">review_similarto</span><span class="p">.</span><span class="n">other_review_id</span> <span class="k">is</span> <span class="s1">'The other similar review-id (take minimum id, if more than one).  If r1, r4, r7 are all similar, then: (r4,r1), (r7,r1)'</span><span class="p">;</span>
</pre></div>
<p>In presentation layer, this derivation can be used to filter out similar reviews for statistical-based Report or also can be used to report on duplicate reviews explicitly.</p>
<p>The results so far are interesting...I'll write a dedicate post on these once harvesting of my sub-set is completed.</p>
<h3 id="other-derived-components">Other derived components</h3>
<p>From similar Reviews derivation, we could try to identify same users across sites. There is no direct way to identify these from our source data.  A possible (indirect) way could be to use reviews similarity. Let's say we have a business rules like :  <em>Flag user from different sites as being the same whenever more than x reviews are highly similar</em>. This would be straightforward to implement using the derivations above.</p>
<div class="highlight"><pre><span></span><span class="k">create</span> <span class="k">table</span> <span class="n">integration</span><span class="p">.</span><span class="n">user_sameas</span> <span class="p">(</span>
    <span class="n">user_id</span> <span class="n">uuid</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">same_user_id</span> <span class="n">uuid</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">valid_from</span> <span class="k">timestamp</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">valid_to</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">create_dts</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">update_dts</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">load_audit_id</span> <span class="nb">int</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">same_user_id</span><span class="p">,</span> <span class="n">valid_from</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="k">references</span> <span class="n">integration</span><span class="p">.</span><span class="k">user</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">on</span> <span class="k">delete</span> <span class="k">cascade</span><span class="p">,</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">same_user_id</span><span class="p">)</span> <span class="k">references</span> <span class="n">integration</span><span class="p">.</span><span class="k">user</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">on</span> <span class="k">delete</span> <span class="k">cascade</span><span class="p">,</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">load_audit_id</span><span class="p">)</span> <span class="k">references</span> <span class="n">staging</span><span class="p">.</span><span class="n">load_audit</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">comment</span> <span class="k">on</span> <span class="k">table</span> <span class="n">integration</span><span class="p">.</span><span class="n">user_sameas</span> <span class="k">as</span> <span class="s1">'Store "same-as" user across sites spotted when multiple reviews have very similar text (exact rules TBD)'</span><span class="p">;</span>
<span class="k">comment</span> <span class="k">on</span> <span class="k">column</span> <span class="n">integration</span><span class="p">.</span><span class="n">user_sameas</span><span class="p">.</span><span class="n">user_id</span> <span class="k">as</span> <span class="s1">'All user_id in diff sites recognized as same user'</span><span class="p">;</span>
<span class="k">comment</span> <span class="k">on</span> <span class="k">column</span> <span class="n">integration</span><span class="p">.</span><span class="n">user_sameas</span><span class="p">.</span><span class="n">same_user_id</span> <span class="k">as</span> <span class="s1">'Flag to identify same user_id (taken arbitrarily)'</span><span class="p">;</span>

<span class="c1">-- .. recursive hierarchical relations</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">integration</span><span class="p">.</span><span class="n">mds_parent</span> <span class="p">(</span>
    <span class="n">code</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">parent_code</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">create_dts</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">load_audit_id</span> <span class="nb">int</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">parent_code</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="k">references</span> <span class="n">integration</span><span class="p">.</span><span class="n">mds</span><span class="p">(</span><span class="n">code</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">parent_code</span><span class="p">)</span> <span class="k">references</span> <span class="n">integration</span><span class="p">.</span><span class="n">mds</span><span class="p">(</span><span class="n">code</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">load_audit_id</span><span class="p">)</span> <span class="k">references</span> <span class="n">staging</span><span class="p">.</span><span class="n">load_audit</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
<h3 id="data-cleansing">Data cleansing</h3>
<p>Also relevant here is to fix data issues... One example is related to Work-id loaded from thingISBN.xml export. There are ids that correspond to duplicates of other id (probably later merged to the same Work). These are discovered during harvesting, when Librarything host re-directs request using such duplicate id to a page corresponding to its "master" id. This is stored using the <code>work_sameas</code> table:</p>
<div class="highlight"><pre><span></span><span class="k">create</span> <span class="k">table</span> <span class="n">integration</span><span class="p">.</span><span class="n">work_sameas</span> <span class="p">(</span>
    <span class="n">work_refid</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">master_refid</span> <span class="nb">bigint</span><span class="p">,</span>
    <span class="n">create_dts</span> <span class="k">timestamp</span><span class="p">,</span>
    <span class="n">load_audit_id</span> <span class="nb">int</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">work_refid</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">work_refid</span><span class="p">)</span> <span class="k">references</span> <span class="n">integration</span><span class="p">.</span><span class="k">work</span><span class="p">(</span><span class="n">refid</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">master_refid</span><span class="p">)</span> <span class="k">references</span> <span class="n">integration</span><span class="p">.</span><span class="k">work</span><span class="p">(</span><span class="n">refid</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">load_audit_id</span><span class="p">)</span> <span class="k">references</span> <span class="n">staging</span><span class="p">.</span><span class="n">load_audit</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">comment</span> <span class="k">on</span> <span class="k">table</span> <span class="n">integration</span><span class="p">.</span><span class="n">work_sameas</span> <span class="k">is</span> <span class="s1">'Different work_refid may exist in lt for same "master" Work'</span><span class="p">;</span>
<span class="k">comment</span> <span class="k">on</span> <span class="k">column</span> <span class="n">integration</span><span class="p">.</span><span class="n">work_sameas</span><span class="p">.</span><span class="n">master_refid</span> <span class="k">is</span> <span class="s1">'The "master" work that work_refid refers to'</span><span class="p">;</span>
</pre></div>
<h3 id="wrap-up">Wrap-up</h3>
<p>This concludes the series of posts presenting some aspects of data integration using the Book Review Dataset as test case. I'll later present some aspects on the Presentation layer, but for that I need to decide which Cloud provider BRD will be tested on.  Presentation layer schema design is very much influenced by data access tools and this is rapidly evolving.</p>
            </div>

            <!-- MO: added for series -->
                <p>This post is part 3 of the "BRD-DI" series:</p>
                <ol class="parts">
                    <li >
                        <a href='http://datapfranc.github.io/misc/BRD_DI_part1/'>How to do data integration, BRD example</a>
                    </li>
                    <li >
                        <a href='http://datapfranc.github.io/misc/BRD_DI_part2/'>How to do data integration, BRD example (part2)</a>
                    </li>
                    <li class="active">
                        <a href='http://datapfranc.github.io/misc/BRD_DI_part3/'>How to do data integration, BRD example (part3)</a>
                    </li>
               </ol>

            <!-- /.entry-content -->
    <hr />
    <!-- AddThis Button BEGIN -->
    <!--<div class="addthis_toolbox addthis_default_style">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
            <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    </div>-->



   <!-- Go to www.addthis.com/dashboard to customize your tools -->
    <!-- <div class="addthis_sharing_toolbox"></div> -->
    <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
        <a class="addthis_counter_facebook"></a>
        <a class="addthis_counter_twitter"></a>
        <a class="addthis_button_google_plusone_share"></a>
        <a class="addthis_button_email"></a>
        <a class="addthis_button_linkedin"></a>
        <a class="addthis_button_compact"></a>
        <a class="addthis_counter addthis_bubble_style"></a>
    </div>


    <!-- AddThis Button END -->
    <!-- Go to www.addthis.com/dashboard to customize your tools -->


        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="http://github.com/mart2010"><i class="fa fa-github-square fa-lg"></i> github</a></li>
                <li class="list-group-item"><a href="https://twitter.com/datapfranc"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
                <li class="list-group-item"><a href="http://linkedin.com/in/martinouellet"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
                <li class="list-group-item"><a href="http://martin-ouellet.blogspot.ch/"><i class="fa fa-personal-blog-square fa-lg"></i> Personal blog</a></li>
                <li class="list-group-item"><a href="http://datapfranc.github.io/feeds/all.atom.xml"><i class="fa fa-rss-square fa-lg"></i> rss</a></li>
              </ul>
            </li>

            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
                <ul class="list-group" id="recentposts">
                    <li class="list-group-item">
                        <a href="http://datapfranc.github.io/misc/brd_why/">
                            Why Book Review?
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://datapfranc.github.io/misc/BRD_DI_part1/">
                            How to do data integration, BRD example
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://datapfranc.github.io/misc/BRD_DI_part2/">
                            How to do data integration, BRD example (part2)
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://datapfranc.github.io/misc/BRD_DI_part3/">
                            How to do data integration, BRD example (part3)
                        </a>
                    </li>
                </ul>
            </li>


            <li class="list-group-item"><a href="http://datapfranc.github.io/tags.html"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags">
                    <li class="list-group-item tag-1">
                        <a href="http://datapfranc.github.io/tags/brd.html">
                            BRD
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://datapfranc.github.io/tags/data-integration.html">
                            data integration
                        </a>
                    </li>
                </ul>
            </li>

    <li class="list-group-item"><h4><i class="fa fa-twitter fa-lg"></i><span class="icon-label">Latest Tweets</span></h4></li>
    <div id="twitter_timeline">
        <a class="twitter-timeline" data-chrome="noheader" href="https://twitter.com/dataPFranc" data-widget-id="738675033866940416">Tweets by dataPFranc</a>
    </div>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

        <!--     <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.dbms2.com/" target="_blank">
                DBMS2
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://librarything.com/" target="_blank">
                Librarything
            </a>
        </li>
        <li class="list-group-item">
            <a href="https://www.goodreads.com/" target="_blank">
                Goodreads
            </a>
        </li>
        <li class="list-group-item">
            <a href="https://babelio.com/" target="_blank">
                Babelio
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://cloudofdata.com/blog/" target="_blank">
                Paul Miller blog
            </a>
        </li>
      </ul>
    </li>
 -->
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="well well-lg" id="footer-well">
      <div class="container">
      <div class="row">
        <!-- MO:removed to show Twitter latest instead (next 4 lines)
          <div id="RecentComments" class="dsq-widget">
           <h3 style="margin-bottom:0.5px;">Recent Comments</h3>
           <script type="text/javascript" src="http://.disqus.com/recent_comments_widget.js?num_items=5&hide_mods=0&hide_avatars=0&avatar_size=32&excerpt_length=100"></script>
          </div>
        -->
           <div class="col-sm-4">
             <div id="RecentComments" class="dsq-widget">
               <h3 style="margin-bottom:0.5px;">Latest Tweets</h3>

    <li class="list-group-item"><h4><i class="fa fa-twitter fa-lg"></i><span class="icon-label">Latest Tweets</span></h4></li>
    <div id="twitter_timeline">
        <a class="twitter-timeline" data-chrome="noheader" href="https://twitter.com/dataPFranc" data-widget-id="738675033866940416">Tweets by dataPFranc</a>
    </div>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

           </div>
           <div class="col-sm-4">
               <h3 style="margin-bottom:0.5px;">Websites I Like</h3>
               </br>
               <ul style="list-style-type:circle">
                <div style="margin-bottom: 10.5px; margin-top: 10.5px; font-size: 19px;">
                  <li>
                    <a href="http://www.dbms2.com/" target="_blank">
                        DBMS2
                    </a>
                  </li>
                <div>
                <div style="margin-bottom: 10.5px; margin-top: 10.5px; font-size: 19px;">
                  <li>
                    <a href="http://librarything.com/" target="_blank">
                        Librarything
                    </a>
                  </li>
                <div>
                <div style="margin-bottom: 10.5px; margin-top: 10.5px; font-size: 19px;">
                  <li>
                    <a href="https://www.goodreads.com/" target="_blank">
                        Goodreads
                    </a>
                  </li>
                <div>
                <div style="margin-bottom: 10.5px; margin-top: 10.5px; font-size: 19px;">
                  <li>
                    <a href="https://babelio.com/" target="_blank">
                        Babelio
                    </a>
                  </li>
                <div>
                <div style="margin-bottom: 10.5px; margin-top: 10.5px; font-size: 19px;">
                  <li>
                    <a href="http://cloudofdata.com/blog/" target="_blank">
                        Paul Miller blog
                    </a>
                  </li>
                <div>
              </ul>

             <!-- // <script src="https://apis.google.com/js/platform.js" async defer></script> -->
              <!-- <g:plusone size="standard(bubble)" data-href="http://the-data-show.com"></g:plusone> -->
              <br>
              <h3>Share DataPlatform Franchising</h3>
                <div class="addthis_toolbox addthis_default_style addthis_32x32_style" addthis:url="http://datapfranc.github.io" addthis:title="Check out DataPlatform Franchising!">
                  <a class="addthis_button_facebook"></a>
                  <a class="addthis_button_twitter"></a>
                  <a class="addthis_button_google_plusone_share"></a>
                  <a class="addthis_button_email"></a>
                  <a class="addthis_button_linkedin"></a>
                  <a class="addthis_button_rss_follow" addthis:userid="http://datapfranc.github.io/feeds/all.atom.xml"></a>
                  <a class="addthis_button_compact"></a>
                </div>
                <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-572cd8ecd555b197"></script>
           </div>
           <div class="col-sm-4">
<div id="aboutme" align="center">
	<h3 style="margin-bottom:0.5px;">About Martin Ouellet</h3><br/>
        <p>
            <img width="60%" class="img-thumbnail" src="/images/headshot_2.jpg"/>
        </p>
    <p> 
        I'm a data architect by choice. I enjoy doing backend stuff and data-oriented projects.<p>Find out more about me at <strong><a href="http://martin-ouellet.blogspot.ch" title="Personal Archive">martin-ouellet</a></strong></p><p>You can also contact me <a href='mailto:mart2010.l@gmail.com?subject=dataPFranc-feedback'>here</a>
    </p>
</div>
           </div>
      </div>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 Martin Ouellet
            &middot; Powered by <a href="http://python.org/" target="_blank">Python</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            adapted from <a href="http://beneathdata.com" target="_blank">beneathdata</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
   </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://datapfranc.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://datapfranc.github.io/theme/js/respond.min.js"></script>

<!-- Fix scrolling issues to internal HREFs that get positioned behind navbar -->
<!-- http://stackoverflow.com/questions/10732690/offsetting-an-html-anchor-to-adjust-for-fixed-header -->
<script src="http://datapfranc.github.io/theme/js/href_scroll.js"></script>

    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-49087367-2']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>